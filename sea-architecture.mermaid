%%{init: {'theme': 'light', 'themeVariables': { 'primaryColor': '#a371f7', 'primaryTextColor': '#c9d1d9', 'primaryBorderColor': '#30363d', 'lineColor': '#58a6ff', 'secondaryColor': '#161b22', 'tertiaryColor': '#21262d'}}}%%

flowchart TB
    subgraph TRIGGER["ğŸ”´ TRIGGER LAYER"]
        T1[/"ğŸ“… Calendar Event<br/><code>merger_meeting_tokyo</code>"/]
        T2[/"âœˆï¸ Flight Disruption<br/><code>cancellation_event</code>"/]
    end

    subgraph EDGE["ğŸ”µ EDGE LAYER <i>local_device</i>"]
        E1["ğŸš¨ Crisis Detector<br/><code>main.py</code>"]
        E2["ğŸ­ Inner Monologue<br/><code>reasoning_trace</code>"]
    end

    subgraph SOVEREIGN["ğŸŸ£ SOVEREIGN CLOUD"]
        direction TB
        
        subgraph ORCHESTRATOR["Orchestrator Layer"]
            O1["ğŸ§  Claude via MCP<br/><code>anthropic_sdk</code>"]
        end

        subgraph REASONING["Reasoning Engine"]
            R1["ğŸ” BFS Airport Search"]
            R2["ğŸš„ Intermodal Analysis"]
            R3["âš–ï¸ Decision Matrix<br/><code>time > cost > comfort</code>"]
            KB["ğŸ“Š Knowledge Base<br/><code>dict + pydantic</code>"]
        end

        subgraph PRIVACY["Privacy Shield Layer"]
            P1["ğŸ›¡ï¸ Data Redaction Proxy<br/><code>privacy_shield.py</code>"]
            P2["ğŸ”’ Identity Hasher<br/><code>hash_identity()</code>"]
        end

        subgraph EXECUTOR["Action Executor"]
            AE["âš™ï¸ Booking Engine<br/><code>HITL_optional</code>"]
        end
    end

    subgraph EXTERNAL["âšª EXTERNAL APIs <i>untrusted</i>"]
        X1["âœˆï¸ Mock GDS<br/><code>Amadeus/Sabre</code>"]
        X2["ğŸš„ Rail API<br/><code>JR Shinkansen</code>"]
        X3["ğŸš— Ground Transport"]
        X4["ğŸ’³ Payment Gateway<br/><code>PCI-DSS tokenized</code>"]
    end

    %% Trigger flows
    T1 & T2 --> E1

    %% Edge to Sovereign
    E1 -->|"crisis_payload"| O1
    E2 -.->|"trace_log"| O1

    %% Orchestrator to Reasoning
    O1 --> R1
    R1 --> R2
    R2 --> R3
    KB -.-> R1 & R2 & R3

    %% Reasoning to Privacy
    R3 --> P1
    P1 --> P2

    %% Privacy to Executor
    P2 -->|"redacted_request"| AE

    %% Executor to External (through privacy)
    AE ==>|"Corporate Ref #441"| X1
    AE ==>|"Corporate Ref #441"| X2
    AE ==>|"Corporate Ref #441"| X3
    AE ==>|"tokenized_payment"| X4

    %% Styling - no background fills
    classDef trigger fill:none,stroke:#f85149,stroke-width:2px
    classDef edge fill:none,stroke:#58a6ff,stroke-width:2px
    classDef sovereign fill:none,stroke:#a371f7,stroke-width:2px
    classDef external fill:none,stroke:#8b949e,stroke-width:1px,stroke-dasharray: 5 5
    classDef privacy fill:none,stroke:#7ee787,stroke-width:2px

    class T1,T2 trigger
    class E1,E2 edge
    class O1,R1,R2,R3,KB,AE sovereign
    class P1,P2 privacy
    class X1,X2,X3,X4 external
